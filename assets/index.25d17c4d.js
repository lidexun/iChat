import{r as M,W as u,M as _,N as l,y as p,R as g,Y as y,O as i,P as h,Q as D,ad as k,S as v,ae as b}from"./index.fc0e2afd.js";import{N as C}from"./index.c57e1302.js";import{o as I}from"./user.87d65084.js";import{g as S}from"./user.b36f1c33.js";import{e as x}from"./bus.0e6517c1.js";import"./use-placeholder.8dc646e9.js";const w={class:"message"},E={class:"message_list"},H=["onClick"],N={class:"message_item_box van-hairline--bottom"},B=["textContent"],O={class:"content"},T=["innerHTML"],P={__name:"index",setup(j){let a=M({messageList:[]});const d=u.getItem("userInfo")._id,r=new Map;function L(t){var e=new Date;t&&(e=new Date(t));var o=e.getFullYear(),n=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,s=e.getDate()<10?"0"+e.getDate():e.getDate(),m=e.getHours()<10?"0"+e.getHours():e.getHours(),f=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes();return e.getSeconds()<10?""+e.getSeconds():e.getSeconds(),o+"-"+n+"-"+s+" "+m+":"+f}S().then(t=>{const{data:e}=t;for(let o=0;o<e.length;o++){const n=e[o],s=n.from_uid===d?n.to_uid:n.from_uid;let m=r.get(s);m?r.set(s,[...m,n]):r.set(s,[n])}u.setItem("messageList",Object.fromEntries(r)),r.forEach((o,n)=>{a.messageList.push(c(o[0]))})});function c(t){const e=t;return e.content=e.content.replace(/&amp;/g," ").replace(/&nbsp;/g," ").replace(/<br\/>/g," "),e.addtime=L(t.createdTime),e.timestamp=Math.round(new Date(t.createdTime)/1e3),e}return x.on("send_message",t=>{const e=t.to_uid;let o=r.get(e);o?r.set(e,[...o,t]):r.set(e,[t]),u.setItem("messageList",Object.fromEntries(r));const n=a.messageList.findIndex(s=>s.from_uid===e||s.to_uid===e);a.messageList[n]={...c(t),userinfo:t.userinfo}}),x.on("message",t=>{const e=t.from_uid===d?t.to_uid:t.from_uid;let o=r.get(e);o?r.set(e,[...o,t]):r.set(e,[t]),u.setItem("messageList",Object.fromEntries(r)),a.messageList=a.messageList.map((n,s)=>n.from_uid===t.from_uid?{...c(t),userinfo:n.userinfo}:n)}),(t,e)=>{const o=C,n=b("user-avatar");return _(),l(h,null,[p(o,{title:"chat","right-text":"\u67E5\u627E\u7528\u6237",fixed:"",onClickRight:e[0]||(e[0]=s=>g(y).push("search"))}),i("div",w,[i("ul",E,[(_(!0),l(h,null,D(g(a).messageList,(s,m)=>(_(),l("li",{class:"message_item",onClick:f=>g(I)(s.userinfo._id),style:k({order:`-${s.timestamp}`})},[p(n,{name:s.userinfo.username,round:""},null,8,["name"]),i("div",N,[i("div",{class:"name",textContent:v(s.userinfo.username)},null,8,B),i("div",O,v(s.content),1),i("div",{class:"addtime",innerHTML:s.addtime},null,8,T)])],12,H))),256))])])],64)}}};export{P as default};
