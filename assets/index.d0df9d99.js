import{c as K,d as O,Z as he,H as z,a as y,m as ee,t as ge,C as L,E as pe,q as te,w as Y,r as C,ag as ve,D as ne,ah as ye,L as Te,O as xe,ac as se,M as H,ai as be,f as we,_ as ae,o as S,a0 as A,$ as q,g as $,j as oe,S as ie,l as le,F as N,V as Se,aj as ke,ak as U,N as De,I as $e,i as T,h as w,a2 as Ie,a3 as Ee,k as Ce,al as Me,am as G,an as W,ao as He,ap as Le,aq as Z,a1 as J,n as Ve}from"./index.cbf740b8.js";import{B as Pe}from"./index.9ce463fe.js";import{N as Be}from"./index.7ee81d01.js";import{a as Q,g as je,b as Ne}from"./user.38720db7.js";import{d as qe,t as j}from"./message.14aaca3b.js";import{d as Re}from"./index.1e454d50.js";import"./use-route.7f7622c4.js";import"./use-placeholder.1543164c.js";const[ce,Fe]=K("row"),re=Symbol(ce),Ue={tag:ee("div"),wrap:ge,align:String,gutter:L(0),justify:String};var ze=O({name:ce,props:Ue,setup(i,{slots:l}){const{children:g,linkChildren:o}=he(re),u=z(()=>{const s=[[]];let e=0;return g.forEach((n,m)=>{e+=Number(n.span),e>24?(s.push([m]),e-=24):s[s.length-1].push(m)}),s}),d=z(()=>{const s=Number(i.gutter),e=[];return s&&u.value.forEach(n=>{const m=s*(n.length-1)/n.length;n.forEach((x,c)=>{if(c===0)e.push({right:m});else{const p=s-e[x-1].right,I=m-p;e.push({left:p,right:I})}})}),e});return o({spaces:d}),()=>{const{tag:s,wrap:e,align:n,justify:m}=i;return y(s,{class:Fe({[`align-${n}`]:n,[`justify-${m}`]:m,nowrap:!e})},{default:()=>{var x;return[(x=l.default)==null?void 0:x.call(l)]}})}}});const[Ae,Ke]=K("col"),Oe={tag:ee("div"),span:L(0),offset:te};var Ye=O({name:Ae,props:Oe,setup(i,{slots:l}){const{parent:g,index:o}=pe(re),u=z(()=>{if(!g)return;const{spaces:d}=g;if(d&&d.value&&d.value[o.value]){const{left:s,right:e}=d.value[o.value];return{paddingLeft:s?`${s}px`:null,paddingRight:e?`${e}px`:null}}});return()=>{const{tag:d,span:s,offset:e}=i;return y(d,{style:u.value,class:Ke({[s]:s,[`offset-${e}`]:e})},{default:()=>{var n;return[(n=l.default)==null?void 0:n.call(l)]}})}}});const Xe=Y(Ye),[Ge,M,We]=K("pull-refresh"),ue=50,Ze=["pulling","loosing","success"],Je={disabled:Boolean,modelValue:Boolean,headHeight:L(ue),successText:String,pullingText:String,loosingText:String,loadingText:String,pullDistance:te,successDuration:L(500),animationDuration:L(300)};var Qe=O({name:Ge,props:Je,emits:["change","refresh","update:modelValue"],setup(i,{emit:l,slots:g}){let o;const u=C(),d=C(),s=ve(u),e=ne({status:"normal",distance:0,duration:0}),n=ye(),m=()=>{if(i.headHeight!==ue)return{height:`${i.headHeight}px`}},x=()=>e.status!=="loading"&&e.status!=="success"&&!i.disabled,c=t=>{const r=+(i.pullDistance||i.headHeight);return t>r&&(t<r*2?t=r+(t-r)/2:t=r*1.5+(t-r*2)/4),Math.round(t)},p=(t,r)=>{const k=+(i.pullDistance||i.headHeight);e.distance=t,r?e.status="loading":t===0?e.status="normal":t<k?e.status="pulling":e.status="loosing",l("change",{status:e.status,distance:t})},I=()=>{const{status:t}=e;return t==="normal"?"":i[`${t}Text`]||We(t)},V=()=>{const{status:t,distance:r}=e;if(g[t])return g[t]({distance:r});const k=[];return Ze.includes(t)&&k.push(y("div",{class:M("text")},[I()])),t==="loading"&&k.push(y(se,{class:M("loading")},{default:I})),k},E=()=>{e.status="success",setTimeout(()=>{p(0)},+i.successDuration)},P=t=>{o=be(s.value)===0,o&&(e.duration=0,n.start(t))},R=t=>{x()&&P(t)},F=t=>{if(x()){o||P(t);const{deltaY:r}=n;n.move(t),o&&r.value>=0&&n.isVertical()&&(we(t),p(c(r.value)))}},B=()=>{o&&n.deltaY.value&&x()&&(e.duration=+i.animationDuration,e.status==="loosing"?(p(+i.headHeight,!0),l("update:modelValue",!0),H(()=>l("refresh"))):p(0))};return Te(()=>i.modelValue,t=>{e.duration=+i.animationDuration,t?p(+i.headHeight,!0):g.success||i.successText?E():p(0,!1)}),xe("touchmove",F,{target:d}),()=>{var t;const r={transitionDuration:`${e.duration}ms`,transform:e.distance?`translate3d(0,${e.distance}px, 0)`:""};return y("div",{ref:u,class:M()},[y("div",{ref:d,class:M("track"),style:r,onTouchstartPassive:R,onTouchend:B,onTouchcancel:B},[y("div",{class:M("head"),style:m()},[V()]),(t=g.default)==null?void 0:t.call(g)])])}}});const et=Y(Qe),tt=Y(ze);const nt={__name:"index",emits:["change"],setup(i,{emit:l}){const g=["\u{1F600}","\u{1F603}","\u{1F604}","\u{1F601}","\u{1F606}","\u{1F605}","\u{1F602}","\u{1F642}","\u{1F643}","\u{1F609}","\u{1F60A}","\u{1F607}","\u{1F60D}","\u{1F618}","\u{1F617}","\u{1F61A}","\u{1F619}","\u{1F60B}","\u{1F61B}","\u{1F61C}","\u{1F61D}","\u{1F911}","\u{1F917}","\u{1F914}","\u{1F910}","\u{1F610}","\u{1F611}","\u{1F636}","\u{1F60F}","\u{1F612}","\u{1F644}","\u{1F62C}","\u{1F60C}","\u{1F614}","\u{1F634}","\u{1F637}","\u{1F912}","\u{1F915}","\u{1F635}","\u{1F60E}","\u{1F913}","\u{1F615}","\u{1F61F}","\u{1F641}","\u{1F62E}","\u{1F62F}","\u{1F632}","\u{1F633}","\u{1F627}","\u{1F628}","\u{1F630}","\u{1F625}","\u{1F62D}","\u{1F631}","\u{1F616}","\u{1F623}","\u{1F61E}","\u{1F629}","\u{1F624}","\u{1F621}","\u{1F620}"];function o(u){l("change",{data:u})}return(u,d)=>{const s=Xe,e=tt;return S(),A(e,{class:"emoji_box",align:"center"},{default:q(()=>[(S(),$(N,null,oe(g,n=>y(s,{class:"emoji_item",span:"3",onClick:m=>o(n)},{default:q(()=>[ie(le(n),1)]),_:2},1032,["onClick"])),64))]),_:1})}}},st=ae(nt,[["__scopeId","data-v-c98a710c"]]);const at={class:"chat"},ot={class:"chat_list_content"},it=["innerHTML"],lt={class:"chat_list_item_addtime"},ct={class:"footer"},rt={class:"footer_box"},ut={class:"content"},dt={class:"footer_button"},mt=ie("\u53D1\u9001"),ft={__name:"index",setup(i){const l=C(!1),g=Ce(),o=Me(),u=Se.getItem("userInfo"),d=C({});let s=1,e=15,n=C(""),m=C(null),x=new Map,c=ne({list:[],listEnding:!1,isLoading:!1}),p=[];const I=async()=>{const a=await je(o.query._id);d.value=a.data[0],p=await G("messageStore","chatKey",o.query._id),V(),E()},V=async()=>{if(c.listEnding)return;const a=(s-1)*e,f=s*e,v=[],D=p.sort((b,_)=>new Date(_.createTime)-new Date(b.createTime)).slice(a,f).map(b=>{let _=qe(b.createTime).split(" ");return x.get(_[0])||(x.set(_[0],1),v.push({type:2,addtime:_[0],timestamp:Math.round(+new Date(`${_[0]} 00:00:00`)/1e3)})),j(b)});c.list.length>=p.length&&(c.listEnding=!0),c.list=c.list.concat(D,v),c.isLoading=!1,s++};function E(a=999999){H(()=>{document.documentElement.scrollIntoView(!1)})}function P(a){a.target.innerHTML==="<br>"?n.value="":n.value=a.target.innerHTML}function R(){if(l.value||m.value.focus(),!n.value)return;let a=m.value.innerText.replace(/â†µ/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;");const f={content_type:1,content:a,to_uid:o.query._id,from_uid:u._id},v=o.query._id+Math.round(+new Date/1e3);c.list.push(j({...f,isSendType:1,createTime:Math.round(+new Date/1e3),msgKey:v})),E(),m.value.textContent="",n.value="",Ne(f).then(D=>{const b=c.list.findIndex(_=>_.msgKey===v);c.list[b]=j(D.data),U.emit("send_message",D.data)})}const F=async()=>{const a=document.body.offsetHeight;await V(),s!==1&&H(()=>{document.documentElement.scrollTop=document.body.offsetHeight-a})};function B(){l.value=!1,document.activeElement.blur()}function t(){l.value=!1;const a=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);setTimeout(()=>{E(),a&&setTimeout(()=>{E()},100)},a?0:350)}const r=a=>{!o.query._id||o.query._id!==a.from_uid||(c.list.push(j(a)),H(()=>{const f=document.documentElement,v=f.getBoundingClientRect();Number.parseInt(v.height)-Number.parseInt(v.bottom)>50&&f.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})}),k())},k=Re(function(){Q(o.query._id).then(()=>{X(o.query._id)})},1e3);async function X(a,f){const v=await G("messageStore","chatKey",a);if(v.length>0){v.filter(_=>_.is_read===0).forEach(_=>{_.is_read===0&&(_.is_read="1",W("messageStore",_))});const b=await He("latestMsgFetched",a);b!=="null"&&W("latestMsgFetched",{...b,count:0})}}ke(()=>{U.off("chat_message",r)}),De(()=>{I(),U.on("chat_message",r),Q(o.query._id).then(()=>{X(o.query._id)})});function de(){l.value=!l.value,H(()=>{document.documentElement.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})})}function me(a){n.value+=a.data,m.value.textContent+=a.data}return(a,f)=>{const v=Be,D=Ve("user-avatar"),b=se,_=et,fe=$e,_e=Pe;return S(),$("div",at,[y(v,{fixed:"","left-arrow":"",title:d.value.username||"",onClickLeft:f[0]||(f[0]=h=>T(g).back()),placeholder:""},null,8,["title"]),y(_,{disabled:T(c).listEnding,modelValue:T(c).isLoading,"onUpdate:modelValue":f[2]||(f[2]=h=>T(c).isLoading=h),"pulling-text":"\u4E0B\u62C9\u52A0\u8F7D\u66F4\u591A","loosing-text":"\u677E\u5F00\u52A0\u8F7D\u6570\u636E","loading-text":"\u52A0\u8F7D\u4E2D",onRefresh:F},{default:q(()=>[w("ul",{class:"chat_list",id:"chat_list",onTouchstart:f[1]||(f[1]=h=>B())},[(S(!0),$(N,null,oe(T(c).list,(h,_t)=>(S(),$(N,null,[h.type?(S(),$("li",{key:1,class:"chat_list_item on_time",style:Z({order:`${h.timestamp}`})},[w("div",lt,le(h.addtime),1)],4)):(S(),$("li",{key:0,class:Le(["chat_list_item",{on:h.from_uid===T(u)._id}]),style:Z({order:h.timestamp})},[(S(),A(D,{key:h.from_uid===T(u)._id?T(u).username:d.value.username,width:"0.38rem",height:"0.38rem",name:h.from_uid===T(u)._id?T(u).username:d.value.username,round:""},null,8,["width","height","name"])),w("div",ot,[h.from_uid===T(u)._id?(S(),$(N,{key:0},[h.isSendType===1?(S(),A(b,{key:0,class:"loading",size:"0.18rem",color:"#1989fa"})):J("",!0)],64)):J("",!0),w("div",{class:"content",innerHTML:h.contentHTML},null,8,it)])],6))],64))),256))],32)]),_:1},8,["disabled","modelValue"]),w("footer",ct,[w("div",rt,[w("div",{class:"emoji",onClick:de},[y(fe,{name:"smile-o",size:"30"})]),w("div",ut,[w("div",{ref_key:"content_input",ref:m,class:"input",contenteditable:"",style:{"-webkit-user-select":"auto"},placeholder:"\u8BF7\u8F93\u5165\u6587\u5B57",onInput:P,onFocus:f[3]||(f[3]=h=>t()),autocapitalize:"off","safe-area-inset-bottom":""},null,544)]),w("div",dt,[y(_e,{disabled:T(n).length<=0,class:"button",size:"large",type:"primary",onClick:R},{default:q(()=>[mt]),_:1},8,["disabled"])])]),Ie(y(st,{onChange:me},null,512),[[Ee,l.value]])])])}}},wt=ae(ft,[["__scopeId","data-v-26af8566"]]);export{wt as default};
