import{c as Z,d as ee,r as H,ag as te,D as G,ah as se,L as ne,O as ae,a as T,C as R,q as oe,ac as J,M as q,ai as ie,f as le,w as re,V as ce,aj as ue,a4 as F,N as de,o as p,g as S,i as m,_ as A,h as v,k as me,ak as fe,al as z,am as K,an as _e,F as U,j as he,ao as ge,ap as j,$ as O,a0 as X,l as pe,S as ve,n as Te}from"./index.6371e9a2.js";import{B as ye}from"./index.aaadf39c.js";import{N as be}from"./index.79473e8d.js";import{a as Y,g as xe,b as De}from"./user.e495c624.js";import{d as Se,t as C}from"./message.14aaca3b.js";import{d as we}from"./index.1e454d50.js";import{_ as ke}from"./_plugin-vue_export-helper.cdc0426e.js";import"./use-route.cedf7895.js";import"./use-placeholder.c9beafbc.js";const[Me,I,Ie]=Z("pull-refresh"),Q=50,He=["pulling","loosing","success"],Ee={disabled:Boolean,modelValue:Boolean,headHeight:R(Q),successText:String,pullingText:String,loosingText:String,loadingText:String,pullDistance:oe,successDuration:R(500),animationDuration:R(300)};var Le=ee({name:Me,props:Ee,emits:["change","refresh","update:modelValue"],setup(i,{emit:w,slots:l}){let u;const y=H(),b=H(),k=te(y),t=G({status:"normal",distance:0,duration:0}),_=se(),E=()=>{if(i.headHeight!==Q)return{height:`${i.headHeight}px`}},n=()=>t.status!=="loading"&&t.status!=="success"&&!i.disabled,L=e=>{const a=+(i.pullDistance||i.headHeight);return e>a&&(e<a*2?e=a+(e-a)/2:e=a*1.5+(e-a*2)/4),Math.round(e)},h=(e,a)=>{const g=+(i.pullDistance||i.headHeight);t.distance=e,a?t.status="loading":e===0?t.status="normal":e<g?t.status="pulling":t.status="loosing",w("change",{status:t.status,distance:e})},M=()=>{const{status:e}=t;return e==="normal"?"":i[`${e}Text`]||Ie(e)},D=()=>{const{status:e,distance:a}=t;if(l[e])return l[e]({distance:a});const g=[];return He.includes(e)&&g.push(T("div",{class:I("text")},[M()])),e==="loading"&&g.push(T(J,{class:I("loading")},{default:M})),g},N=()=>{t.status="success",setTimeout(()=>{h(0)},+i.successDuration)},V=e=>{u=ie(k.value)===0,u&&(t.duration=0,_.start(e))},$=e=>{n()&&V(e)},P=e=>{if(n()){u||V(e);const{deltaY:a}=_;_.move(e),u&&a.value>=0&&_.isVertical()&&(le(e),h(L(a.value)))}},B=()=>{u&&_.deltaY.value&&n()&&(t.duration=+i.animationDuration,t.status==="loosing"?(h(+i.headHeight,!0),w("update:modelValue",!0),q(()=>w("refresh"))):h(0))};return ne(()=>i.modelValue,e=>{t.duration=+i.animationDuration,e?h(+i.headHeight,!0):l.success||i.successText?N():h(0,!1)}),ae("touchmove",P,{target:b}),()=>{var e;const a={transitionDuration:`${t.duration}ms`,transform:t.distance?`translate3d(0,${t.distance}px, 0)`:""};return T("div",{ref:y,class:I()},[T("div",{ref:b,class:I("track"),style:a,onTouchstartPassive:$,onTouchend:B,onTouchcancel:B},[T("div",{class:I("head"),style:E()},[D()]),(e=l.default)==null?void 0:e.call(l)])])}}});const Ve=re(Le);const Be={class:"chat"},Ce={class:"chat_list_content"},qe=["innerHTML"],Ne={class:"chat_list_item_addtime"},$e={class:"footer"},Pe={class:"content"},Re={class:"footer_button"},Fe=ve("\u53D1\u9001"),Ue={__name:"index",setup(i){const w=me(),l=fe(),u=ce.getItem("userInfo"),y=H({});let b=1,k=15,t=H(""),_=H(null),E=new Map,n=G({list:[],listEnding:!1,isLoading:!1}),L=[];const h=async()=>{const s=await xe(l.query._id);y.value=s.data[0],L=await z("messageStore","chatKey",l.query._id),M(),D()},M=async()=>{if(n.listEnding)return;const s=(b-1)*k,o=b*k,d=[],x=L.sort((f,r)=>new Date(r.createTime)-new Date(f.createTime)).slice(s,o).map(f=>{let r=Se(f.createTime).split(" ");return E.get(r[0])||(E.set(r[0],1),d.push({type:2,addtime:r[0],timestamp:Math.round(+new Date(`${r[0]} 00:00:00`)/1e3)})),C(f)});n.list.length<k&&(n.listEnding=!0),n.list=n.list.concat(x,d),b++};function D(s=999999){q(()=>{document.documentElement.scrollIntoView(!1)})}function N(s){s.target.innerHTML==="<br>"?t.value="":t.value=s.target.innerHTML}function V(){if(_.value.focus(),!t.value)return;let s=_.value.innerText.replace(/â†µ/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;");const o={content_type:1,content:s,to_uid:l.query._id,from_uid:u._id},d=l.query._id+Math.round(+new Date/1e3);n.list.push(C({...o,isSendType:1,createTime:Math.round(+new Date/1e3),msgKey:d})),D(),_.value.textContent="",t.value="",De(o).then(x=>{const f=n.list.findIndex(r=>r.msgKey===d);n.list[f]=C(x.data),F.emit("send_message",x.data)})}const $=async()=>{if(await M(),b!==1){const s=document.body.offsetHeight;q(()=>{document.documentElement.scrollTop=document.body.offsetHeight-s})}};function P(){document.activeElement.blur()}function B(){const s=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);setTimeout(()=>{D(),s&&setTimeout(()=>{D()},100)},s?0:350)}const e=s=>{!l.query._id||l.query._id!==s.from_uid||(n.list.push(C(s)),q(()=>{const o=document.documentElement,d=o.getBoundingClientRect();Number.parseInt(d.height)-Number.parseInt(d.bottom)>50&&o.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})}),a())},a=we(function(){Y(l.query._id).then(()=>{g(l.query._id)})},1e3);async function g(s,o){const d=await z("messageStore","chatKey",s);if(d.length>0){d.filter(r=>r.is_read===0).forEach(r=>{r.is_read===0&&(r.is_read="1",K("messageStore",r))});const f=await _e("latestMsgFetched",s);f!=="null"&&K("latestMsgFetched",{...f,count:0})}}return ue(()=>{F.off("chat_message",e)}),de(()=>{h(),F.on("chat_message",e),Y(l.query._id).then(()=>{g(l.query._id)})}),(s,o)=>{const d=be,x=Te("user-avatar"),f=J,r=Ve,W=ye;return p(),S("div",Be,[T(d,{fixed:"","left-arrow":"",title:y.value.username||"",onClickLeft:o[0]||(o[0]=c=>m(w).back()),placeholder:""},null,8,["title"]),T(r,{disabled:m(n).listEnding,modelValue:m(n).isLoading,"onUpdate:modelValue":o[2]||(o[2]=c=>m(n).isLoading=c),"pulling-text":"\u4E0B\u62C9\u52A0\u8F7D\u66F4\u591A","loosing-text":"\u677E\u5F00\u52A0\u8F7D\u6570\u636E","loading-text":"\u52A0\u8F7D\u4E2D",onRefresh:$},{default:A(()=>[v("ul",{class:"chat_list",id:"chat_list",onTouchstart:o[1]||(o[1]=c=>P())},[(p(!0),S(U,null,he(m(n).list,(c,Ae)=>(p(),S(U,null,[c.type?(p(),S("li",{key:1,class:"chat_list_item on_time",style:j({order:`${c.timestamp}`})},[v("div",Ne,pe(c.addtime),1)],4)):(p(),S("li",{key:0,class:ge(["chat_list_item",{on:c.from_uid===m(u)._id}]),style:j({order:c.timestamp})},[(p(),O(x,{key:c.from_uid===m(u)._id?m(u).username:y.value.username,width:"0.38rem",height:"0.38rem",name:c.from_uid===m(u)._id?m(u).username:y.value.username,round:""},null,8,["width","height","name"])),v("div",Ce,[c.from_uid===m(u)._id?(p(),S(U,{key:0},[c.isSendType===1?(p(),O(f,{key:0,class:"loading",size:"0.18rem",color:"#1989fa"})):X("",!0)],64)):X("",!0),v("div",{class:"content",innerHTML:c.contentHTML},null,8,qe)])],6))],64))),256))],32)]),_:1},8,["disabled","modelValue"]),v("footer",$e,[v("div",Pe,[v("div",{ref_key:"content_input",ref:_,class:"input",contenteditable:"",style:{"-webkit-user-select":"auto"},placeholder:"\u8BF7\u8F93\u5165\u6587\u5B57",onInput:N,onFocus:o[3]||(o[3]=c=>B()),autocapitalize:"off","safe-area-inset-bottom":""},null,544)]),v("div",Re,[T(W,{disabled:m(t).length<=0,class:"button",size:"large",type:"primary",onClick:V},{default:A(()=>[Fe]),_:1},8,["disabled"])])])])}}},We=ke(Ue,[["__scopeId","data-v-c6d8d6d1"]]);export{We as default};
