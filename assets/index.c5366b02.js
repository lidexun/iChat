import{c as W,d as Z,r as M,ag as ee,D as Y,ah as te,L as se,O as ae,a as v,C as P,q as ne,ac as G,M as C,ai as oe,f as ie,w as le,V as re,a4 as F,N as ce,o as g,g as D,i as d,_ as U,h as p,k as ue,aj as de,ak as A,al as z,am as me,F as R,j as fe,an as _e,ao as K,$ as j,a0 as O,l as he,S as ge,n as pe}from"./index.cb71e29c.js";import{B as ve}from"./index.09e405b4.js";import{N as Te}from"./index.89d9f226.js";import{a as X,g as ye,b as xe}from"./user.54dcb223.js";import{t as B,d as be}from"./message.f54ff5d8.js";import{d as De}from"./index.1e454d50.js";import{_ as Se}from"./_plugin-vue_export-helper.cdc0426e.js";import"./use-route.eedd3dde.js";import"./use-placeholder.635160f2.js";const[we,I,ke]=W("pull-refresh"),J=50,Ie=["pulling","loosing","success"],Me={disabled:Boolean,modelValue:Boolean,headHeight:P(J),successText:String,pullingText:String,loosingText:String,loadingText:String,pullDistance:ne,successDuration:P(500),animationDuration:P(300)};var He=Z({name:we,props:Me,emits:["change","refresh","update:modelValue"],setup(i,{emit:S,slots:r}){let u;const T=M(),y=M(),w=ee(T),s=Y({status:"normal",distance:0,duration:0}),f=te(),H=()=>{if(i.headHeight!==J)return{height:`${i.headHeight}px`}},n=()=>s.status!=="loading"&&s.status!=="success"&&!i.disabled,E=e=>{const a=+(i.pullDistance||i.headHeight);return e>a&&(e<a*2?e=a+(e-a)/2:e=a*1.5+(e-a*2)/4),Math.round(e)},h=(e,a)=>{const t=+(i.pullDistance||i.headHeight);s.distance=e,a?s.status="loading":e===0?s.status="normal":e<t?s.status="pulling":s.status="loosing",S("change",{status:s.status,distance:e})},k=()=>{const{status:e}=s;return e==="normal"?"":i[`${e}Text`]||ke(e)},b=()=>{const{status:e,distance:a}=s;if(r[e])return r[e]({distance:a});const t=[];return Ie.includes(e)&&t.push(v("div",{class:I("text")},[k()])),e==="loading"&&t.push(v(G,{class:I("loading")},{default:k})),t},N=()=>{s.status="success",setTimeout(()=>{h(0)},+i.successDuration)},V=e=>{u=oe(w.value)===0,u&&(s.duration=0,f.start(e))},$=e=>{n()&&V(e)},q=e=>{if(n()){u||V(e);const{deltaY:a}=f;f.move(e),u&&a.value>=0&&f.isVertical()&&(ie(e),h(E(a.value)))}},L=()=>{u&&f.deltaY.value&&n()&&(s.duration=+i.animationDuration,s.status==="loosing"?(h(+i.headHeight,!0),S("update:modelValue",!0),C(()=>S("refresh"))):h(0))};return se(()=>i.modelValue,e=>{s.duration=+i.animationDuration,e?h(+i.headHeight,!0):r.success||i.successText?N():h(0,!1)}),ae("touchmove",q,{target:y}),()=>{var e;const a={transitionDuration:`${s.duration}ms`,transform:s.distance?`translate3d(0,${s.distance}px, 0)`:""};return v("div",{ref:T,class:I()},[v("div",{ref:y,class:I("track"),style:a,onTouchstartPassive:$,onTouchend:L,onTouchcancel:L},[v("div",{class:I("head"),style:H()},[b()]),(e=r.default)==null?void 0:e.call(r)])])}}});const Ee=le(He);const Ve={class:"chat"},Le={class:"chat_list_content"},Be=["innerHTML"],Ce={class:"chat_list_item_addtime"},Ne={class:"footer"},$e={class:"content"},qe={class:"footer_button"},Pe=ge("\u53D1\u9001"),Re={__name:"index",setup(i){const S=ue(),r=de(),u=re.getItem("userInfo"),T=M({});let y=1,w=15,s=M(""),f=M(null),H=new Map,n=Y({list:[],listEnding:!1,isLoading:!1}),E=[];const h=async()=>{const t=await ye(r.query._id);T.value=t.data[0],E=await A("messageStore","chatKey",r.query._id),k(),b()},k=async()=>{if(n.listEnding)return;const t=(y-1)*w,o=y*w,m=[],x=E.sort((_,l)=>new Date(l.createTime)-new Date(_.createTime)).slice(t,o).map(_=>{let l=be(_.createTime).split(" ");return H.get(l[0])||(H.set(l[0],1),m.push({type:2,addtime:l[0],timestamp:Math.round(+new Date(`${l[0]} 00:00:00`)/1e3)})),B(_)});n.list.length<w&&(n.listEnding=!0),n.list=n.list.concat(x,m),y++};function b(t=999999){C(()=>{document.documentElement.scrollIntoView(!1)})}function N(t){t.target.innerHTML==="<br>"?s.value="":s.value=t.target.innerHTML}function V(){if(f.value.focus(),!s.value)return;let t=f.value.innerText.replace(/â†µ/g,"<br/>").replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;");const o={content_type:1,content:t,to_uid:r.query._id,from_uid:u._id},m=r.query._id+Math.round(+new Date/1e3);n.list.push(B({...o,isSendType:1,createTime:Math.round(+new Date/1e3),msgKey:m})),b(),f.value.textContent="",s.value="",xe(o).then(x=>{const _=n.list.findIndex(l=>l.msgKey===m);n.list[_]=B(x.data),F.emit("send_message",x.data)})}const $=async()=>{if(await k(),y!==1){const t=document.body.offsetHeight;C(()=>{document.documentElement.scrollTop=document.body.offsetHeight-t})}};function q(){document.activeElement.blur()}function L(){const t=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);setTimeout(()=>{b(),t&&setTimeout(()=>{b()},100)},t?0:350)}F.on("chat_message"+r.query._id,t=>{n.list.push(B(t)),C(()=>{const o=document.documentElement,m=o.getBoundingClientRect();Number.parseInt(m.height)-Number.parseInt(m.bottom)>50&&o.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})}),e()});const e=De(function(){X(r.query._id).then(()=>{a(r.query._id)})},1e3);async function a(t,o){(await A("messageStore","chatKey",t)).filter(l=>l.is_read===0).forEach(l=>{l.is_read===0&&(l.is_read="1",z("messageStore",l))});const _=await me(["latestMsgFetched"],t);z("latestMsgFetched",{..._,count:0})}return ce(()=>{h(),X(r.query._id).then(()=>{a(r.query._id)})}),(t,o)=>{const m=Te,x=pe("user-avatar"),_=G,l=Ee,Q=ve;return g(),D("div",Ve,[v(m,{fixed:"","left-arrow":"",title:T.value.username||"",onClickLeft:o[0]||(o[0]=c=>d(S).back()),placeholder:""},null,8,["title"]),v(l,{disabled:d(n).listEnding,modelValue:d(n).isLoading,"onUpdate:modelValue":o[2]||(o[2]=c=>d(n).isLoading=c),"pulling-text":"\u4E0B\u62C9\u52A0\u8F7D\u66F4\u591A","loosing-text":"\u677E\u5F00\u52A0\u8F7D\u6570\u636E","loading-text":"\u52A0\u8F7D\u4E2D",onRefresh:$},{default:U(()=>[p("ul",{class:"chat_list",id:"chat_list",onTouchstart:o[1]||(o[1]=c=>q())},[(g(!0),D(R,null,fe(d(n).list,(c,Fe)=>(g(),D(R,null,[c.type?(g(),D("li",{key:1,class:"chat_list_item on_time",style:K({order:`${c.timestamp}`})},[p("div",Ce,he(c.addtime),1)],4)):(g(),D("li",{key:0,class:_e(["chat_list_item",{on:c.from_uid===d(u)._id}]),style:K({order:c.timestamp})},[(g(),j(x,{key:c.from_uid===d(u)._id?d(u).username:T.value.username,width:"0.38rem",height:"0.38rem",name:c.from_uid===d(u)._id?d(u).username:T.value.username,round:""},null,8,["width","height","name"])),p("div",Le,[c.from_uid===d(u)._id?(g(),D(R,{key:0},[c.isSendType===1?(g(),j(_,{key:0,class:"loading",size:"0.18rem",color:"#1989fa"})):O("",!0)],64)):O("",!0),p("div",{class:"content",innerHTML:c.contentCopy},null,8,Be)])],6))],64))),256))],32)]),_:1},8,["disabled","modelValue"]),p("footer",Ne,[p("div",$e,[p("div",{ref_key:"content_input",ref:f,class:"input",contenteditable:"",style:{"-webkit-user-select":"auto"},placeholder:"\u8BF7\u8F93\u5165\u6587\u5B57",onInput:N,onFocus:o[3]||(o[3]=c=>L()),autocapitalize:"off","safe-area-inset-bottom":""},null,544)]),p("div",qe,[v(Q,{disabled:d(s).length<=0,class:"button",size:"large",type:"primary",onClick:V},{default:U(()=>[Pe]),_:1},8,["disabled"])])])])}}},Je=Se(Re,[["__scopeId","data-v-07ac337e"]]);export{Je as default};
